<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICSE Planner - Syllabus Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --bg: #0f0f1a;
            --card: #1a1a2e;
            --card-hover: #252542;
            --border: #2a2a4a;
            --text: #ffffff;
            --text-muted: #9ca3af;
        }

        body {
            background: var(--bg);
            min-height: 100vh;
        }

        /* Animated Background */
        .bg-pattern {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(34, 211, 238, 0.05) 0%, transparent 50%);
        }

        .floating-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            animation: float 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -50px) scale(1.1); }
            50% { transform: translate(-30px, 30px) scale(0.9); }
            75% { transform: translate(30px, 50px) scale(1.05); }
        }

        /* Card Styles */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.1);
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #6366f1 0%, #ec4899 50%, #6366f1 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-primary span {
            position: relative;
            z-index: 1;
        }

        /* Subject Card */
        .subject-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .subject-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .subject-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s;
        }

        .subject-header:hover {
            background: var(--card-hover);
        }

        .subject-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .subject-content.open {
            max-height: 2000px;
            transition: max-height 0.6s ease-in;
        }

        .chapter-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .chapter-item:hover {
            background: var(--card-hover);
            padding-left: 28px;
        }

        .chapter-item.completed {
            background: rgba(34, 197, 94, 0.1);
        }

        .chapter-item.completed .chapter-name {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        /* Custom Checkbox */
        .checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .checkbox.checked {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            animation: check-bounce 0.4s ease;
        }

        @keyframes check-bounce {
            0% { transform: scale(1); }
            30% { transform: scale(1.2); }
            60% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .checkbox svg {
            width: 14px;
            height: 14px;
            stroke: white;
            stroke-width: 3;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease;
        }

        .checkbox.checked svg {
            opacity: 1;
            transform: scale(1);
        }

        /* Bookmark */
        .bookmark {
            color: var(--text-muted);
            transition: all 0.3s;
            cursor: pointer;
        }

        .bookmark:hover {
            color: #fbbf24;
        }

        .bookmark.active {
            color: #fbbf24;
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Timer */
        .timer-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px;
            padding: 16px 24px;
            text-align: center;
            min-width: 90px;
        }

        .timer-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(180deg, #fff, #a5b4fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            z-index: 101;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        /* Confetti */
        .confetti {
            position: fixed;
            z-index: 200;
            animation: confetti-fall linear forwards;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        /* Loading */
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Page transitions */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats */
        .stat-ring {
            transform: rotate(-90deg);
        }

        .stat-ring circle {
            transition: stroke-dasharray 1s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        /* Arrow rotation */
        .arrow {
            transition: transform 0.3s ease;
        }

        .arrow.open {
            transform: rotate(180deg);
        }

        /* Filter buttons */
        .filter-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--text);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Subject icon */
        .subject-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* Difficulty badge */
        .difficulty {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .difficulty-easy { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .difficulty-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .difficulty-hard { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* Theme */
        .theme-purple { --primary: #a855f7; --primary-light: #c084fc; }
        .theme-pink { --primary: #ec4899; --primary-light: #f472b6; }
        .theme-blue { --primary: #3b82f6; --primary-light: #60a5fa; }
        .theme-green { --primary: #22c55e; --primary-light: #4ade80; }
        .theme-orange { --primary: #f97316; --primary-light: #fb923c; }
        .theme-red { --primary: #ef4444; --primary-light: #f87171; }

        /* Light mode */
        .light-mode {
            --bg: #f5f5f5;
            --card: #ffffff;
            --card-hover: #f0f0f0;
            --border: #e0e0e0;
            --text: #1a1a2e;
            --text-muted: #6b7280;
        }

        .light-mode .gradient-text {
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="text-white">
    <!-- Background -->
    <div class="bg-pattern"></div>
    <div class="floating-orb" style="width: 400px; height: 400px; background: rgba(99, 102, 241, 0.3); top: -100px; left: -100px;"></div>
    <div class="floating-orb" style="width: 300px; height: 300px; background: rgba(236, 72, 153, 0.2); bottom: -50px; right: -50px; animation-delay: -10s;"></div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f0f1a]">
        <div class="text-center">
            <div class="loader mx-auto mb-6"></div>
            <h1 class="text-2xl font-bold gradient-text">ICSE Planner</h1>
            <p class="text-gray-500 mt-2 text-sm">Loading...</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsBackdrop" class="modal-backdrop" onclick="closeSettings()"></div>
    <div id="settingsModal" class="modal">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <span>‚öôÔ∏è</span> Settings
            </h2>
            <button onclick="closeSettings()" class="p-2 hover:bg-white/10 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Theme Mode -->
        <div class="mb-6">
            <label class="text-sm text-gray-400 mb-3 block">Theme Mode</label>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="setThemeMode('dark')" id="darkModeBtn" class="p-3 rounded-xl border border-gray-700 hover:border-indigo-500 transition flex items-center justify-center gap-2">
                    <span>üåô</span> Dark
                </button>
                <button onclick="setThemeMode('light')" id="lightModeBtn" class="p-3 rounded-xl border border-gray-700 hover:border-yellow-500 transition flex items-center justify-center gap-2">
                    <span>‚òÄÔ∏è</span> Light
                </button>
            </div>
        </div>

        <!-- Accent Color -->
        <div class="mb-6">
            <label class="text-sm text-gray-400 mb-3 block">Accent Color</label>
            <div class="flex gap-3 justify-center">
                <button onclick="setThemeColor('indigo')" data-color="indigo" class="color-option w-10 h-10 rounded-full bg-indigo-500 transition hover:scale-110"></button>
                <button onclick="setThemeColor('purple')" data-color="purple" class="color-option w-10 h-10 rounded-full bg-purple-500 transition hover:scale-110"></button>
                <button onclick="setThemeColor('pink')" data-color="pink" class="color-option w-10 h-10 rounded-full bg-pink-500 transition hover:scale-110"></button>
                <button onclick="setThemeColor('blue')" data-color="blue" class="color-option w-10 h-10 rounded-full bg-blue-500 transition hover:scale-110"></button>
                <button onclick="setThemeColor('green')" data-color="green" class="color-option w-10 h-10 rounded-full bg-green-500 transition hover:scale-110"></button>
                <button onclick="setThemeColor('orange')" data-color="orange" class="color-option w-10 h-10 rounded-full bg-orange-500 transition hover:scale-110"></button>
            </div>
        </div>

        <!-- Exam Date -->
        <div class="mb-6">
            <label class="text-sm text-gray-400 mb-3 block">Exam Date</label>
            <div class="flex gap-2">
                <input type="date" id="newExamDate" class="flex-1 px-4 py-3 bg-white/5 rounded-xl border border-gray-700 focus:border-indigo-500 outline-none transition">
                <button onclick="updateExamDate()" class="px-4 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-medium transition">
                    Save
                </button>
            </div>
        </div>

        <!-- Reset -->
        <div class="flex gap-3">
            <button onclick="resetProgress()" class="flex-1 p-3 bg-yellow-500/10 text-yellow-400 rounded-xl hover:bg-yellow-500/20 transition text-sm font-medium">
                Reset Progress
            </button>
            <button onclick="resetAll()" class="flex-1 p-3 bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition text-sm font-medium">
                Reset All
            </button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app">
        <!-- Auth Page -->
        <div id="authPage" class="page active min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md text-center">
                <img src="https://upload.wikimedia.org/wikipedia/en/thumb/c/c4/CISCE_logo.png/150px-CISCE_logo.png" 
                     alt="ICSE" class="w-20 h-20 mx-auto rounded-full bg-white p-2 shadow-xl mb-6">
                <h1 class="text-4xl font-extrabold gradient-text mb-2">ICSE Planner</h1>
                <p class="text-gray-400 mb-8">Track your syllabus, ace your exams</p>

                <div class="card p-8">
                    <button onclick="signInWithGoogle()" id="googleSignInBtn" 
                        class="w-full py-4 px-6 bg-white text-gray-800 rounded-xl font-semibold flex items-center justify-center gap-3 hover:bg-gray-100 transition">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Continue with Google
                    </button>
                    <div id="authLoading" class="hidden py-4">
                        <div class="loader mx-auto w-8 h-8 border-2"></div>
                    </div>
                    <div id="authError" class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm hidden"></div>
                </div>

                <div class="mt-8 flex flex-wrap justify-center gap-4 text-sm text-gray-500">
                    <span>‚úì Track Progress</span>
                    <span>‚úì Exam Timer</span>
                    <span>‚úì Cloud Sync</span>
                    <span>‚úì Bookmarks</span>
                </div>
            </div>
        </div>

        <!-- Setup Page -->
        <div id="setupPage" class="page min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-xl">
                <div class="text-center mb-8">
                    <span class="inline-block px-4 py-1 bg-indigo-500/20 text-indigo-400 rounded-full text-sm mb-4">Setup</span>
                    <h1 class="text-3xl font-bold">Welcome, <span id="setupUserName" class="gradient-text"></span>!</h1>
                    <p class="text-gray-400 mt-2">Let's set up your tracker</p>
                </div>

                <div class="card p-8">
                    <!-- Step 1 -->
                    <div id="step1" class="step">
                        <h2 class="text-xl font-bold text-center mb-6">Choose Your Stream</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="selectStream('science')" class="p-6 rounded-xl border border-gray-700 hover:border-indigo-500 transition text-left group">
                                <div class="text-4xl mb-3 group-hover:scale-110 transition">üî¨</div>
                                <h3 class="font-bold">Science</h3>
                                <p class="text-xs text-gray-500">Physics, Chemistry, Biology, Math</p>
                            </button>
                            <button onclick="selectStream('commerce')" class="p-6 rounded-xl border border-gray-700 hover:border-purple-500 transition text-left group">
                                <div class="text-4xl mb-3 group-hover:scale-110 transition">üìä</div>
                                <h3 class="font-bold">Commerce</h3>
                                <p class="text-xs text-gray-500">Commercial Studies, Economics</p>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div id="step2" class="step hidden">
                        <h2 class="text-xl font-bold text-center mb-6">Choose Your Optional</h2>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="selectOptional('computer')" class="p-4 rounded-xl border border-gray-700 hover:border-cyan-500 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">üíª</div>
                                <h3 class="font-semibold text-sm">Computer</h3>
                            </button>
                            <button onclick="selectOptional('pe')" class="p-4 rounded-xl border border-gray-700 hover:border-green-500 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">‚öΩ</div>
                                <h3 class="font-semibold text-sm">Physical Ed</h3>
                            </button>
                            <button onclick="selectOptional('art')" class="p-4 rounded-xl border border-gray-700 hover:border-pink-500 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">üé®</div>
                                <h3 class="font-semibold text-sm">Art</h3>
                            </button>
                        </div>
                        <button onclick="goBackToStep1()" class="mt-6 text-sm text-gray-400 hover:text-white transition flex items-center gap-1 mx-auto">
                            ‚Üê Go Back
                        </button>
                    </div>

                    <!-- Step 3 -->
                    <div id="step3" class="step hidden">
                        <h2 class="text-xl font-bold text-center mb-6">When is Your Exam?</h2>
                        <input type="date" id="examDate" class="w-full px-4 py-4 bg-white/5 rounded-xl border border-gray-700 focus:border-indigo-500 outline-none transition text-center text-lg mb-4">
                        <button onclick="completeSetup()" class="btn-primary w-full py-4 rounded-xl font-bold text-lg">
                            <span>üöÄ Start Tracking</span>
                        </button>
                        <button onclick="goBackToStep2()" class="mt-4 text-sm text-gray-400 hover:text-white transition flex items-center gap-1 mx-auto">
                            ‚Üê Go Back
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
            <!-- Header -->
            <header class="sticky top-0 z-40 bg-[#0f0f1a]/80 backdrop-blur-lg border-b border-gray-800">
                <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/c/c4/CISCE_logo.png/150px-CISCE_logo.png" 
                             alt="ICSE" class="w-9 h-9 rounded-full bg-white p-0.5">
                        <h1 class="text-lg font-bold gradient-text hidden sm:block">ICSE Planner</h1>
                    </div>

                    <div class="flex-1 max-w-md mx-4 hidden md:block">
                        <input type="text" id="searchInput" placeholder="Search chapters..." 
                            class="w-full px-4 py-2 bg-white/5 rounded-xl border border-gray-700 focus:border-indigo-500 outline-none text-sm transition"
                            oninput="searchChapters()">
                    </div>

                    <div class="flex items-center gap-2">
                        <button onclick="openSettings()" class="p-2 hover:bg-white/10 rounded-lg transition" title="Settings">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                        <img id="userPhoto" src="" alt="" class="w-8 h-8 rounded-full border-2 border-indigo-500 hidden">
                        <button onclick="logout()" class="p-2 hover:bg-red-500/20 text-red-400 rounded-lg transition" title="Logout">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <main class="container mx-auto px-4 py-6 max-w-6xl">
                <!-- Timer -->
                <div class="card p-6 mb-6">
                    <div class="text-center mb-4">
                        <span class="text-gray-400">‚è±Ô∏è Time Until Exams</span>
                    </div>
                    <div class="flex justify-center gap-3 flex-wrap">
                        <div class="timer-box">
                            <div id="timerDays" class="timer-value">00</div>
                            <div class="text-xs text-gray-400 mt-1">Days</div>
                        </div>
                        <div class="timer-box">
                            <div id="timerHours" class="timer-value">00</div>
                            <div class="text-xs text-gray-400 mt-1">Hours</div>
                        </div>
                        <div class="timer-box">
                            <div id="timerMinutes" class="timer-value">00</div>
                            <div class="text-xs text-gray-400 mt-1">Minutes</div>
                        </div>
                        <div class="timer-box">
                            <div id="timerSeconds" class="timer-value">00</div>
                            <div class="text-xs text-gray-400 mt-1">Seconds</div>
                        </div>
                    </div>
                    <p id="examDateDisplay" class="text-center text-gray-500 text-sm mt-4"></p>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card p-4 text-center">
                        <div class="text-3xl font-bold gradient-text" id="overallProgress">0%</div>
                        <div class="text-xs text-gray-400 mt-1">Progress</div>
                    </div>
                    <div class="card p-4 text-center">
                        <div class="text-3xl font-bold text-green-400" id="chaptersCompleted">0</div>
                        <div class="text-xs text-gray-400 mt-1">Completed</div>
                    </div>
                    <div class="card p-4 text-center">
                        <div class="text-3xl font-bold text-yellow-400" id="chaptersBookmarked">0</div>
                        <div class="text-xs text-gray-400 mt-1">Bookmarked</div>
                    </div>
                    <div class="card p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400" id="totalChapters">0</div>
                        <div class="text-xs text-gray-400 mt-1">Total Chapters</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h2 class="text-xl font-bold">üìö Your Syllabus</h2>
                    <div class="flex gap-2">
                        <button onclick="setFilter('all')" class="filter-btn active" data-filter="all">All</button>
                        <button onclick="setFilter('pending')" class="filter-btn" data-filter="pending">Pending</button>
                        <button onclick="setFilter('completed')" class="filter-btn" data-filter="completed">Done</button>
                        <button onclick="setFilter('bookmarked')" class="filter-btn" data-filter="bookmarked">‚≠ê</button>
                    </div>
                </div>

                <!-- Syllabus -->
                <div id="syllabusContainer" class="space-y-4"></div>

                <!-- Milestones -->
                <div class="mt-8">
                    <h3 class="text-lg font-bold mb-4">üèÜ Milestones</h3>
                    <div id="milestonesContainer" class="flex flex-wrap gap-3"></div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="border-t border-gray-800 mt-12 py-6">
                <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
                    <p class="mb-2">‚ö†Ô∏è <strong>Disclaimer:</strong> This site is <strong>NOT</strong> affiliated to CISCE.</p>
                    <p>Made with ‚ù§Ô∏è for ICSE Students</p>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCqSu-4wkbFNpRINLlHo5sWGM-bPY-MBvM",
            authDomain: "icse-syllabus-tracker.firebaseapp.com",
            projectId: "icse-syllabus-tracker",
            storageBucket: "icse-syllabus-tracker.firebasestorage.app",
            messagingSenderId: "925688497446",
            appId: "1:925688497446:web:17823893ee2350942c2de7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Syllabus Data
        const syllabusData = {
            common: {
                "English Language": {
                    icon: "üìù",
                    color: "#3b82f6",
                    chapters: [
                        "Essay Writing", "Letter Writing (Formal & Informal)", "Notice Writing", "Email Writing",
                        "Comprehension Passage", "Tenses", "Prepositions", "Conjunctions", "Modals",
                        "Subject-Verb Agreement", "Active & Passive Voice", "Direct & Indirect Speech",
                        "Transformation of Sentences", "Question Tags", "Phrasal Verbs & Idioms"
                    ]
                },
                "English Literature": {
                    icon: "üìñ",
                    color: "#8b5cf6",
                    chapters: [
                        "Julius Caesar - Act III", "Julius Caesar - Act IV", "Julius Caesar - Act V",
                        "With the Photographer ‚Äì Stephen Leacock", "The Elevator ‚Äì William Sleator",
                        "The Girl Who Can ‚Äì Ama Ata Aidoo", "The Pedestrian ‚Äì Ray Bradbury",
                        "The Last Lesson ‚Äì Alphonse Daudet", "Haunted Houses ‚Äì H.W. Longfellow",
                        "The Glove and the Lions ‚Äì Leigh Hunt", "When Great Trees Fall ‚Äì Maya Angelou",
                        "A Considerable Speck ‚Äì Robert Frost", "The Power of Music ‚Äì Sukumar Ray"
                    ]
                },
                "Hindi": {
                    icon: "üî§",
                    color: "#f97316",
                    chapters: [
                        "‡§ó‡§¶‡•ç‡§Ø - ‡§¨‡§æ‡§§ ‡§Ö‡§†‡§®‡•ç‡§®‡•Ä ‡§ï‡•Ä", "‡§ó‡§¶‡•ç‡§Ø - ‡§ï‡§æ‡§ï‡•Ä", "‡§ó‡§¶‡•ç‡§Ø - ‡§Æ‡§π‡§æ‡§Ø‡§ú‡•ç‡§û ‡§ï‡§æ ‡§™‡•Å‡§∞‡§∏‡•ç‡§ï‡§æ‡§∞", "‡§ó‡§¶‡•ç‡§Ø - ‡§®‡•á‡§§‡§æ‡§ú‡•Ä ‡§ï‡§æ ‡§ö‡§∂‡•ç‡§Æ‡§æ",
                        "‡§ó‡§¶‡•ç‡§Ø - ‡§Ö‡§™‡§®‡§æ-‡§Ö‡§™‡§®‡§æ ‡§≠‡§æ‡§ó‡•ç‡§Ø", "‡§ó‡§¶‡•ç‡§Ø - ‡§¨‡§°‡§º‡•á ‡§ò‡§∞ ‡§ï‡•Ä ‡§¨‡•á‡§ü‡•Ä", "‡§ó‡§¶‡•ç‡§Ø - ‡§∏‡§Ç‡§¶‡•á‡§π", "‡§ó‡§¶‡•ç‡§Ø - ‡§≠‡•Ä‡§°‡§º ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§Ø‡§æ ‡§Ü‡§¶‡§Æ‡•Ä",
                        "‡§ó‡§¶‡•ç‡§Ø - ‡§≠‡•á‡§°‡§º‡•á‡§Ç ‡§î‡§∞ ‡§≠‡•á‡§°‡§º‡§ø‡§Ø‡•á", "‡§ó‡§¶‡•ç‡§Ø - ‡§¶‡•ã ‡§ï‡§≤‡§æ‡§ï‡§æ‡§∞",
                        "‡§™‡§¶‡•ç‡§Ø - ‡§∏‡§æ‡§ñ‡•Ä", "‡§™‡§¶‡•ç‡§Ø - ‡§ï‡•Å‡§Ç‡§°‡§≤‡§ø‡§Ø‡§æ‡§Å", "‡§™‡§¶‡•ç‡§Ø - ‡§∏‡•ç‡§µ‡§∞‡•ç‡§ó ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç", "‡§™‡§¶‡•ç‡§Ø - ‡§µ‡§π ‡§Æ‡§æ‡§§‡•É‡§≠‡•Ç‡§Æ‡§ø ‡§Æ‡•á‡§∞‡•Ä",
                        "‡§™‡§¶‡•ç‡§Ø - ‡§Æ‡•á‡§ò ‡§Ü‡§è", "‡§™‡§¶‡•ç‡§Ø - ‡§∏‡•Ç‡§∞ ‡§ï‡•á ‡§™‡§¶", "‡§™‡§¶‡•ç‡§Ø - ‡§µ‡§ø‡§®‡§Ø ‡§ï‡•á ‡§™‡§¶", "‡§™‡§¶‡•ç‡§Ø - ‡§≠‡§ø‡§ï‡•ç‡§∑‡•Å‡§ï",
                        "‡§™‡§¶‡•ç‡§Ø - ‡§ö‡§≤‡§®‡§æ ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§ï‡§æ‡§Æ ‡§π‡•à", "‡§™‡§¶‡•ç‡§Ø - ‡§Æ‡§æ‡§§‡•É ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§ï‡•Ä ‡§ì‡§∞",
                        "‡§è‡§ï‡§æ‡§Ç‡§ï‡•Ä - ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§æ‡§∞ ‡§î‡§∞ ‡§≠‡§æ‡§µ‡§®‡§æ", "‡§è‡§ï‡§æ‡§Ç‡§ï‡•Ä - ‡§¨‡§π‡•Ç ‡§ï‡•Ä ‡§µ‡§ø‡§¶‡§æ", "‡§è‡§ï‡§æ‡§Ç‡§ï‡•Ä - ‡§Æ‡§æ‡§§‡•É‡§≠‡•Ç‡§Æ‡§ø ‡§ï‡§æ ‡§Æ‡§æ‡§®",
                        "‡§è‡§ï‡§æ‡§Ç‡§ï‡•Ä - ‡§∏‡•Ç‡§ñ‡•Ä ‡§°‡§æ‡§≤‡•Ä", "‡§è‡§ï‡§æ‡§Ç‡§ï‡•Ä - ‡§Æ‡§π‡§æ‡§≠‡§æ‡§∞‡§§ ‡§ï‡•Ä ‡§è‡§ï ‡§∏‡§æ‡§Å‡§ù", "‡§è‡§ï‡§æ‡§Ç‡§ï‡•Ä - ‡§¶‡•Ä‡§™‡§¶‡§æ‡§®",
                        "‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ - ‡§∏‡§Ç‡§ß‡§ø", "‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ - ‡§∏‡§Æ‡§æ‡§∏", "‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ - ‡§Æ‡•Å‡§π‡§æ‡§µ‡§∞‡•á ‡§î‡§∞ ‡§≤‡•ã‡§ï‡•ã‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å",
                        "‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ - ‡§Ö‡§™‡§†‡§ø‡§§ ‡§ó‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§∂", "‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ - ‡§™‡§§‡•ç‡§∞ ‡§≤‡•á‡§ñ‡§®", "‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ - ‡§®‡§ø‡§¨‡§Ç‡§ß ‡§≤‡•á‡§ñ‡§®"
                    ]
                },
                "History & Civics": {
                    icon: "üèõÔ∏è",
                    color: "#eab308",
                    chapters: [
                        "The First War of Independence 1857", "Growth of Nationalism",
                        "First Phase of Indian National Movement (1885-1907)",
                        "Second Phase of Indian National Movement (1905-1916)",
                        "Mahatma Gandhi and the National Movement", "The Freedom Movement (1935-1947)",
                        "The First World War", "Rise of Dictatorships", "The Second World War",
                        "United Nations Organization", "Major Challenges Facing the World Today",
                        "The Union Legislature", "The Union Executive", "The Judiciary"
                    ]
                },
                "Geography": {
                    icon: "üåç",
                    color: "#22c55e",
                    chapters: [
                        "Map Work", "Location, Extent and Physical Features of India", "Climate of India",
                        "Soil Resources", "Natural Vegetation", "Water Resources", "Mineral and Energy Resources",
                        "Agriculture in India", "Industries in India", "Transport in India", "Waste Management"
                    ]
                }
            },
            science: {
                "Physics": {
                    icon: "‚öõÔ∏è",
                    color: "#06b6d4",
                    chapters: [
                        "Force, Work, Power and Energy", "Simple Machines", "Calorimetry",
                        "Refraction of Light at Plane Surfaces", "Refraction through a Lens", "Spectrum",
                        "Sound", "Current Electricity", "Electrical Power and Household Circuits",
                        "Electromagnetism", "Radioactivity and Nuclear Energy"
                    ]
                },
                "Chemistry": {
                    icon: "üß™",
                    color: "#a855f7",
                    chapters: [
                        "Periodic Table and Periodicity of Properties", "Chemical Bonding",
                        "Study of Acids, Bases and Salts", "Analytical Chemistry",
                        "Mole Concept and Stoichiometry", "Electrolysis", "Metallurgy",
                        "Study of Compounds - Hydrogen Chloride", "Study of Compounds - Ammonia",
                        "Study of Compounds - Nitric Acid", "Study of Compounds - Sulphuric Acid",
                        "Organic Chemistry"
                    ]
                },
                "Biology": {
                    icon: "üß¨",
                    color: "#10b981",
                    chapters: [
                        "Cell Division", "Genetics", "Human Evolution", "Absorption by Roots",
                        "Transpiration", "Photosynthesis", "Chemical Coordination in Plants",
                        "The Circulatory System", "The Excretory System", "The Nervous System",
                        "The Endocrine System", "The Reproductive System", "Human Population", "Pollution"
                    ]
                },
                "Mathematics": {
                    icon: "üìê",
                    color: "#ef4444",
                    chapters: [
                        "GST (Goods and Services Tax)", "Banking", "Shares and Dividends",
                        "Linear Inequations", "Quadratic Equations", "Ratio and Proportion",
                        "Remainder and Factor Theorem", "Matrices", "Arithmetic Progression",
                        "Geometric Progression", "Coordinate Geometry", "Similarity", "Loci",
                        "Circles", "Constructions", "Mensuration", "Trigonometric Identities",
                        "Heights and Distances", "Statistics", "Probability"
                    ]
                }
            },
            commerce: {
                "Commercial Studies": {
                    icon: "üíº",
                    color: "#64748b",
                    chapters: [
                        "Introduction to Business", "Forms of Business Organizations", "Trade",
                        "Banking Services", "Insurance", "Transport", "Communication", "Warehousing",
                        "Advertising", "Salesmanship", "Entrepreneurship", "Consumer Protection"
                    ]
                },
                "Economics": {
                    icon: "üìà",
                    color: "#14b8a6",
                    chapters: [
                        "Introduction to Economics", "Types of Economies", "Demand and Supply",
                        "Price Determination", "Elasticity of Demand", "National Income",
                        "Money and Banking", "Public Finance", "Indian Economy",
                        "Poverty and Unemployment", "Infrastructure Development", "Globalization"
                    ]
                },
                "Mathematics (Commerce)": {
                    icon: "üî¢",
                    color: "#ec4899",
                    chapters: [
                        "GST (Goods and Services Tax)", "Banking", "Shares and Dividends",
                        "Linear Inequations", "Quadratic Equations", "Ratio and Proportion",
                        "Matrices", "Arithmetic Progression", "Coordinate Geometry",
                        "Mensuration", "Statistics", "Probability"
                    ]
                }
            },
            optional: {
                computer: {
                    "Computer Applications": {
                        icon: "üíª",
                        color: "#0ea5e9",
                        chapters: [
                            "Introduction to Object Oriented Programming", "Elementary Concepts of Objects and Classes",
                            "Values and Data Types", "Operators in Java", "Input in Java",
                            "Mathematical Library Methods", "Conditional Statements", "Iterative Statements",
                            "Nested Loops", "Functions / Methods", "Function Overloading",
                            "Arrays - Single Dimensional", "Arrays - Double Dimensional", "String Handling"
                        ]
                    }
                },
                pe: {
                    "Physical Education": {
                        icon: "üèÉ",
                        color: "#84cc16",
                        chapters: [
                            "Health and Physical Fitness", "First Aid", "Personal Hygiene",
                            "Sports and Nutrition", "Posture and Postural Deformities", "Safety in Sports",
                            "Sports Injuries", "Athletics", "Team Games", "Individual Sports", "Yoga"
                        ]
                    }
                },
                art: {
                    "Art": {
                        icon: "üé®",
                        color: "#f43f5e",
                        chapters: [
                            "Fundamentals of Art and Design", "Elements of Art", "Principles of Design",
                            "Color Theory", "Perspective Drawing", "Still Life Drawing", "Nature Study",
                            "Figure Drawing", "Portrait Drawing", "Landscape Drawing", "Poster Making",
                            "Illustration", "Indian Art Forms", "History of Art"
                        ]
                    }
                }
            }
        };

        // State
        let currentUser = null;
        let userData = {
            stream: '', optional: '', examDate: '',
            progress: {}, bookmarks: {},
            settings: { theme: 'dark', color: 'indigo' }
        };
        let currentFilter = 'all';
        let openSubjects = {};

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('icse_settings');
            if (saved) applySettings(JSON.parse(saved));

            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 300);
            }, 1000);

            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    await loadUserData();
                    if (userData.stream && userData.optional && userData.examDate) {
                        showPage('dashboardPage');
                        renderDashboard();
                        startTimer();
                    } else {
                        document.getElementById('setupUserName').textContent = user.displayName?.split(' ')[0] || 'Student';
                        showPage('setupPage');
                    }
                } else {
                    showPage('authPage');
                }
            });
        });

        // Auth
        async function signInWithGoogle() {
            const btn = document.getElementById('googleSignInBtn');
            const loading = document.getElementById('authLoading');
            btn.classList.add('hidden');
            loading.classList.remove('hidden');
            try {
                await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
            } catch (e) {
                btn.classList.remove('hidden');
                loading.classList.add('hidden');
                document.getElementById('authError').textContent = e.message;
                document.getElementById('authError').classList.remove('hidden');
            }
        }

        async function logout() {
            if (confirm('Logout?')) {
                await auth.signOut();
                showPage('authPage');
                document.getElementById('googleSignInBtn').classList.remove('hidden');
                document.getElementById('authLoading').classList.add('hidden');
            }
        }

        // Data
        async function loadUserData() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) userData = { ...userData, ...doc.data() };
            } catch (e) {}
            const local = localStorage.getItem('icse_user_' + currentUser.uid);
            if (local) userData = { ...userData, ...JSON.parse(local) };
            if (userData.settings) applySettings(userData.settings);
        }

        function saveUserData() {
            // Save to localStorage immediately (fast)
            localStorage.setItem('icse_user_' + currentUser.uid, JSON.stringify(userData));
            
            // Save to Firebase in background (slow, but non-blocking)
            db.collection('users').doc(currentUser.uid).set(userData, { merge: true }).catch(() => {});
        }

        // Pages
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // Setup
        function selectStream(s) {
            userData.stream = s;
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        function selectOptional(o) {
            userData.optional = o;
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('examDate').value = `${new Date().getFullYear() + 1}-03-01`;
        }

        function goBackToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        function goBackToStep2() {
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        async function completeSetup() {
            const date = document.getElementById('examDate').value;
            if (!date) return alert('Select exam date!');
            userData.examDate = date;
            await saveUserData();
            showPage('dashboardPage');
            renderDashboard();
            startTimer();
            createConfetti();
        }

        // Dashboard
        function renderDashboard() {
            const photo = document.getElementById('userPhoto');
            if (currentUser.photoURL) {
                photo.src = currentUser.photoURL;
                photo.classList.remove('hidden');
            }
            renderSyllabus();
            renderMilestones();
        }

        function getSubjects() {
            const subjects = [];
            Object.entries(syllabusData.common).forEach(([n, d]) => subjects.push({ name: n, ...d }));
            if (userData.stream && syllabusData[userData.stream]) {
                Object.entries(syllabusData[userData.stream]).forEach(([n, d]) => subjects.push({ name: n, ...d }));
            }
            if (userData.optional && syllabusData.optional[userData.optional]) {
                Object.entries(syllabusData.optional[userData.optional]).forEach(([n, d]) => subjects.push({ name: n, ...d }));
            }
            return subjects;
        }

        function renderSyllabus() {
            const subjects = getSubjects();
            const container = document.getElementById('syllabusContainer');
            container.innerHTML = '';

            let total = 0, completed = 0, bookmarked = 0;

            subjects.forEach((subject, idx) => {
                const id = subject.name.replace(/[^a-zA-Z0-9]/g, '_');
                const chapters = subject.chapters;
                const done = chapters.filter((_, i) => userData.progress[`${id}_${i}`]).length;
                const pct = Math.round((done / chapters.length) * 100);
                total += chapters.length;
                completed += done;

                // Filter chapters
                let filtered = chapters.map((ch, i) => ({
                    ch, i,
                    done: userData.progress[`${id}_${i}`],
                    starred: userData.bookmarks[`${id}_${i}`]
                }));

                if (currentFilter === 'completed') filtered = filtered.filter(c => c.done);
                else if (currentFilter === 'pending') filtered = filtered.filter(c => !c.done);
                else if (currentFilter === 'bookmarked') filtered = filtered.filter(c => c.starred);

                filtered.forEach(c => { if (c.starred) bookmarked++; });

                if (currentFilter !== 'all' && filtered.length === 0) return;

                const isOpen = openSubjects[id] !== false;

                const html = `
                    <div class="subject-card" data-subject="${id}">
                        <div class="subject-header" onclick="toggleSubject('${id}')">
                            <div class="flex items-center gap-4">
                                <div class="subject-icon" style="background: ${subject.color}20; color: ${subject.color}">
                                    ${subject.icon}
                                </div>
                                <div>
                                    <h3 class="font-bold">${subject.name}</h3>
                                    <p class="text-sm text-gray-400">${done}/${chapters.length} chapters ‚Ä¢ ${pct}%</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="w-24 hidden sm:block">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${pct}%; background: ${subject.color}"></div>
                                    </div>
                                </div>
                                <svg class="arrow w-5 h-5 text-gray-400 ${isOpen ? 'open' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </div>
                        <div class="subject-content ${isOpen ? 'open' : ''}" id="content_${id}">
                            ${filtered.map(({ ch, i, done, starred }) => `
                                <div class="chapter-item ${done ? 'completed' : ''}" data-chapter="${id}_${i}">
                                    <div class="checkbox ${done ? 'checked' : ''}" onclick="toggleChapter('${id}', ${i}, event)">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                    <span class="chapter-name flex-1">${ch}</span>
                                    <span class="bookmark ${starred ? 'active' : ''}" onclick="toggleBookmark('${id}', ${i}, event)">
                                        ${starred ? '‚≠ê' : '‚òÜ'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            document.getElementById('overallProgress').textContent = total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
            document.getElementById('chaptersCompleted').textContent = completed;
            document.getElementById('chaptersBookmarked').textContent = bookmarked;
            document.getElementById('totalChapters').textContent = total;
        }

        function toggleSubject(id) {
            openSubjects[id] = !openSubjects[id];
            const content = document.getElementById('content_' + id);
            const arrow = document.querySelector(`[data-subject="${id}"] .arrow`);
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function toggleChapter(subjectId, index, event) {
            event.stopPropagation();
            const key = `${subjectId}_${index}`;
            const isCompleting = !userData.progress[key];
            userData.progress[key] = isCompleting;
            
            // Instant UI update
            const item = document.querySelector(`[data-chapter="${key}"]`);
            const checkbox = item?.querySelector('.checkbox');
            if (item && checkbox) {
                item.classList.toggle('completed', isCompleting);
                checkbox.classList.toggle('checked', isCompleting);
                if (isCompleting) createConfetti();
            }
            
            // Update stats instantly
            updateStats();
            renderMilestones();
            
            // Save in background (non-blocking)
            saveUserData();
        }

        function toggleBookmark(subjectId, index, event) {
            event.stopPropagation();
            const key = `${subjectId}_${index}`;
            const isBookmarking = !userData.bookmarks[key];
            userData.bookmarks[key] = isBookmarking;
            
            // Instant UI update
            const item = document.querySelector(`[data-chapter="${key}"]`);
            const bookmark = item?.querySelector('.bookmark');
            if (bookmark) {
                bookmark.classList.toggle('active', isBookmarking);
                bookmark.innerHTML = isBookmarking ? '‚≠ê' : '‚òÜ';
            }
            
            // Update stats
            updateStats();
            
            // Save in background (non-blocking)
            saveUserData();
        }
        
        function updateStats() {
            const subjects = getSubjects();
            let total = 0, completed = 0, bookmarked = 0;
            
            subjects.forEach(s => {
                const id = s.name.replace(/[^a-zA-Z0-9]/g, '_');
                s.chapters.forEach((_, i) => {
                    total++;
                    if (userData.progress[`${id}_${i}`]) completed++;
                    if (userData.bookmarks[`${id}_${i}`]) bookmarked++;
                });
            });
            
            document.getElementById('overallProgress').textContent = total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
            document.getElementById('chaptersCompleted').textContent = completed;
            document.getElementById('chaptersBookmarked').textContent = bookmarked;
            document.getElementById('totalChapters').textContent = total;
        }

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-filter="${f}"]`).classList.add('active');
            renderSyllabus();
        }

        function searchChapters() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.chapter-item').forEach(item => {
                const text = item.querySelector('.chapter-name').textContent.toLowerCase();
                item.style.display = text.includes(q) ? '' : 'none';
            });
        }

        // Milestones
        function renderMilestones() {
            const subjects = getSubjects();
            let total = 0, completed = 0;
            subjects.forEach(s => {
                const id = s.name.replace(/[^a-zA-Z0-9]/g, '_');
                s.chapters.forEach((_, i) => {
                    total++;
                    if (userData.progress[`${id}_${i}`]) completed++;
                });
            });

            const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
            const milestones = [
                { p: 25, l: '25%', i: 'üåü' },
                { p: 50, l: '50%', i: 'üî•' },
                { p: 75, l: '75%', i: 'üí™' },
                { p: 100, l: '100%', i: 'üèÜ' }
            ];

            document.getElementById('milestonesContainer').innerHTML = milestones.map(m => `
                <div class="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${pct >= m.p ? 'bg-yellow-500/20 text-yellow-400' : 'bg-white/5 text-gray-500'}">
                    ${m.i} ${m.l}
                </div>
            `).join('');
        }

        // Timer
        function startTimer() {
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (!userData.examDate) return;
            const diff = new Date(userData.examDate) - new Date();
            if (diff <= 0) {
                ['Days', 'Hours', 'Minutes', 'Seconds'].forEach(u => document.getElementById('timer' + u).textContent = '00');
                document.getElementById('examDateDisplay').textContent = 'üéâ Exam time!';
                return;
            }
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('timerDays').textContent = String(d).padStart(2, '0');
            document.getElementById('timerHours').textContent = String(h).padStart(2, '0');
            document.getElementById('timerMinutes').textContent = String(m).padStart(2, '0');
            document.getElementById('timerSeconds').textContent = String(s).padStart(2, '0');
            document.getElementById('examDateDisplay').textContent = 'üìÖ ' + new Date(userData.examDate).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsBackdrop').classList.add('open');
            document.getElementById('settingsModal').classList.add('open');
            document.getElementById('newExamDate').value = userData.examDate || '';
        }

        function closeSettings() {
            document.getElementById('settingsBackdrop').classList.remove('open');
            document.getElementById('settingsModal').classList.remove('open');
        }

        function setThemeMode(mode) {
            userData.settings.theme = mode;
            applySettings(userData.settings);
            saveSettings();
        }

        function setThemeColor(color) {
            userData.settings.color = color;
            applySettings(userData.settings);
            saveSettings();
        }

        function applySettings(s) {
            document.body.classList.toggle('light-mode', s.theme === 'light');
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            if (s.color !== 'indigo') document.body.classList.add('theme-' + s.color);
        }

        function saveSettings() {
            localStorage.setItem('icse_settings', JSON.stringify(userData.settings));
            saveUserData();
        }

        async function updateExamDate() {
            const d = document.getElementById('newExamDate').value;
            if (d) {
                userData.examDate = d;
                await saveUserData();
                updateTimer();
                closeSettings();
            }
        }

        async function resetProgress() {
            if (confirm('Reset all progress?')) {
                userData.progress = {};
                userData.bookmarks = {};
                await saveUserData();
                renderDashboard();
                closeSettings();
            }
        }

        async function resetAll() {
            if (confirm('Reset everything?')) {
                userData = { stream: '', optional: '', examDate: '', progress: {}, bookmarks: {}, settings: { theme: 'dark', color: 'indigo' } };
                await saveUserData();
                closeSettings();
                document.getElementById('setupUserName').textContent = currentUser.displayName?.split(' ')[0] || 'Student';
                showPage('setupPage');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
            }
        }

        // Confetti
        function createConfetti() {
            const colors = ['#6366f1', '#a855f7', '#ec4899', '#22c55e', '#f59e0b'];
            for (let i = 0; i < 30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.top = '-10px';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.width = c.style.height = (Math.random() * 8 + 4) + 'px';
                c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }
    </script>
</body>
</html>
